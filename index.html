<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>産業保健情報ポータル</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; color: #333; line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 1.5rem; margin-bottom: 10px; }
    .status { font-size: 0.85rem; color: #666; margin-bottom: 20px; }
    .status .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .dot.loading { background: #f59e0b; }
    .dot.success { background: #10b981; }
    .dot.error { background: #ef4444; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px; }
    .card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card-header { padding: 12px 16px; color: #fff; }
    .card-header h2 { font-size: 1rem; font-weight: 600; }
    .card-header .issue { font-size: 0.75rem; opacity: 0.9; margin-top: 2px; }
    .card-body { padding: 12px 16px; }
    .article { padding: 8px 0; border-bottom: 1px solid #eee; }
    .article:last-child { border-bottom: none; }
    .article-title { font-size: 0.85rem; font-weight: 500; color: #333; }
    .article-authors { font-size: 0.75rem; color: #666; margin-top: 2px; }
    .no-articles { color: #999; font-size: 0.85rem; padding: 10px 0; }
    .card-footer { padding: 10px 16px; border-top: 1px solid #eee; }
    .card-footer a { font-size: 0.8rem; color: #3b82f6; text-decoration: none; }
    .card-footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <h1>産業保健 最新記事</h1>
    <div class="status" id="status">
      <span class="dot loading"></span>
      <span>読み込み中...</span>
    </div>
    <div class="grid" id="journals"></div>
  </div>

  <script>
    const COLORS = {
      sangyoeisei: '#2563eb',
      indhealth: '#059669',
      ohpfrev: '#dc2626',
      jjomh: '#7c3aed',
      jaohn: '#db2777',
      jaohl: '#1d4ed8'
    };

    async function loadData() {
      const statusEl = document.getElementById('status');
      const journalsEl = document.getElementById('journals');
      
      try {
        const res = await fetch('/.netlify/functions/jstage');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        
        statusEl.innerHTML = '<span class="dot success"></span><span>最終取得: ' + data.updated_at + '</span>';
        
        journalsEl.innerHTML = data.journals.map(function(j) {
          const color = COLORS[j.id] || '#666';
          let articlesHtml = '';
          
          if (j.articles && j.articles.length > 0) {
            articlesHtml = j.articles.map(function(a) {
              return '<div class="article">' +
                '<div class="article-title">' + escapeHtml(a.title) + '</div>' +
                (a.authors ? '<div class="article-authors">' + escapeHtml(a.authors) + '</div>' : '') +
                '</div>';
            }).join('');
          } else {
            articlesHtml = '<div class="no-articles">記事を取得できませんでした</div>';
          }
          
          return '<div class="card">' +
            '<div class="card-header" style="background:' + color + '">' +
              '<h2>' + escapeHtml(j.name) + '</h2>' +
              (j.latest_issue ? '<div class="issue">' + escapeHtml(j.latest_issue) + '</div>' : '') +
            '</div>' +
            '<div class="card-body">' + articlesHtml + '</div>' +
            '<div class="card-footer"><a href="' + j.url + '" target="_blank">J-STAGEで見る →</a></div>' +
          '</div>';
        }).join('');
        
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = '<span class="dot error"></span><span>取得失敗: ' + e.message + '</span>';
        journalsEl.innerHTML = '<p>データの取得に失敗しました。しばらく経ってから再度お試しください。</p>';
      }
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    loadData();
  </script>
</body>
</html>
