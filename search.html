<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <title>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ - SANPO PORTAL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #ffffff;
      --bg-secondary: #fafafa;
      --text: #18181b;
      --text-muted: #71717a;
      --text-light: #a1a1aa;
      --border: #e4e4e7;
      --border-light: #f4f4f5;
      --accent-1: #6366f1;
      --accent-2: #8b5cf6;
      --accent-3: #ec4899;
    }
    body { 
      font-family: "Inter", "Noto Sans JP", -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
      z-index: 100;
    }
    .header-inner {
      max-width: 1200px; margin: 0 auto;
      padding: 18px 40px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .logo {
      font-size: 1rem; font-weight: 600; letter-spacing: 0.02em;
      color: var(--text); text-decoration: none;
      display: flex; align-items: center; gap: 10px;
    }
    .logo-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    .logo-icon svg { width: 18px; height: 18px; color: white; }
    nav { display: flex; gap: 36px; }
    nav a {
      font-size: 0.875rem; font-weight: 450; color: var(--text-muted);
      text-decoration: none; transition: color 0.2s;
    }
    nav a:hover, nav a.active { color: var(--text); }
    main { max-width: 1200px; margin: 0 auto; padding: 120px 40px 80px; }
    @media (max-width: 768px) {
      .header-inner { padding: 14px 20px; }
      nav { gap: 20px; }
      nav a { font-size: 0.8rem; }
      main { padding: 100px 20px 60px; }
    }

    .page-header {
      padding: 40px 0 40px;
    }
    .page-header h1 {
      font-size: clamp(1.75rem, 3vw, 2.5rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 12px;
    }
    .page-header p {
      font-size: 1rem;
      color: var(--text-muted);
    }
    .search-box {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
    }
    .search-input-wrap {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-input {
      flex: 1;
      padding: 14px 20px;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-family: inherit;
    }
    .search-input:focus {
      border-color: var(--accent-1);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .search-btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .search-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    .search-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .search-options {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .search-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .search-options label:has(input:checked) {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      border-color: var(--accent-1);
      color: var(--accent-1);
    }
    .search-options input[type="radio"] {
      accent-color: var(--accent-1);
    }
    .ai-recommend {
      font-size: 0.7rem;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    .synonyms-info {
      margin-top: 16px;
      padding: 14px 18px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
      border-radius: 12px;
      font-size: 0.85rem;
      color: var(--accent-1);
      display: none;
    }
    .synonyms-info.show {
      display: block;
    }
    .synonyms-info .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: white;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 8px;
    }
    .synonyms-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    .synonym-tag {
      background: white;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
    }
    .results-count {
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .result-item {
      display: block;
      padding: 20px 24px;
      background: var(--bg);
      border: 1px solid var(--border-light);
      border-radius: 14px;
      margin-bottom: 12px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
    }
    .result-item:hover {
      border-color: var(--accent-1);
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
      transform: translateY(-2px);
    }
    .result-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .result-title mark {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
      color: var(--accent-1);
      padding: 1px 4px;
      border-radius: 3px;
    }
    .result-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .result-journal {
      display: inline-block;
      background: var(--bg-secondary);
      padding: 3px 10px;
      border-radius: 5px;
      margin-right: 10px;
      font-weight: 500;
    }
    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .no-results h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: var(--text);
    }
    .initial-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-light);
    }
    .initial-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
        </div>
        SANPO PORTAL
      </a>
      <nav>
        <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
        <a href="journals.html">å­¦è¡“èªŒ</a>
        <a href="articles.html">è«–æ–‡</a>
        <a href="seido.html">åˆ¶åº¦</a>
        <a href="search.html" class="active">æ¤œç´¢</a>
      </nav>
    </div>
  </header>
  
  <main>
    <div class="page-header">
      <h1>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</h1>
      <p>ç”£æ¥­ä¿å¥é–¢é€£ã®è«–æ–‡ã‚’AIãŒã‚µãƒãƒ¼ãƒˆã—ã¦æ¨ªæ–­æ¤œç´¢</p>
    </div>
    
    <div class="search-box">
      <div class="search-input-wrap">
        <input type="text" id="searchInput" class="search-input" placeholder="ä¾‹ï¼šãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã€ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã€å¾©è·æ”¯æ´">
        <button onclick="doSearch()" id="searchBtn" class="search-btn">æ¤œç´¢</button>
      </div>
      <div class="search-options">
        <label>
          <input type="radio" name="searchMode" value="exact"> å®Œå…¨ä¸€è‡´
        </label>
        <label>
          <input type="radio" name="searchMode" value="ai" checked> ğŸ¤– AIæ‹¡å¼µæ¤œç´¢
          <span class="ai-recommend">æ¨å¥¨</span>
        </label>
      </div>
      <div id="synonymsInfo" class="synonyms-info"></div>
    </div>
    
    <div id="resultsArea">
      <div class="initial-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <p>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
      </div>
    </div>
  </main>
  
  <script>
    // è«–æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€
    let articles = [];
    
    // é™çš„ã‚·ã‚½ãƒ¼ãƒ©ã‚¹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    const thesaurus = {
      "ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹": ["ç²¾ç¥ä¿å¥", "å¿ƒã®å¥åº·", "ãƒ¡ãƒ³ã‚¿ãƒ«", "mental health", "ç²¾ç¥è¡›ç”Ÿ"],
      "ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯": ["ã‚¹ãƒˆãƒ¬ã‚¹èª¿æŸ»", "å¿ƒç†çš„è² æ‹…", "è·æ¥­æ€§ã‚¹ãƒˆãƒ¬ã‚¹", "stress check"],
      "ã‚¹ãƒˆãƒ¬ã‚¹": ["å¿ƒç†çš„è² æ‹…", "ç²¾ç¥çš„è² æ‹…", "ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼", "stress", "ç·Šå¼µ"],
      "éé‡åŠ´åƒ": ["é•·æ™‚é–“åŠ´åƒ", "éåŠ´", "overwork", "æ™‚é–“å¤–åŠ´åƒ", "æ®‹æ¥­"],
      "å¥åº·è¨ºæ–­": ["å¥è¨º", "å¥åº·è¨ºæŸ»", "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯", "å®šæœŸå¥è¨º", "health examination"],
      "ç”£æ¥­åŒ»": ["äº‹æ¥­å ´åŒ»å¸«", "å˜±è¨—åŒ»", "occupational physician"],
      "ç”£æ¥­ä¿å¥": ["è·åŸŸä¿å¥", "åŠ´åƒè¡›ç”Ÿ", "occupational health", "è·å ´ã®å¥åº·"],
      "å¾©è·æ”¯æ´": ["ãƒªãƒ¯ãƒ¼ã‚¯", "è·å ´å¾©å¸°æ”¯æ´", "å¾©å¸°æ”¯æ´", "return to work"],
      "è·å ´å¾©å¸°": ["å¾©è·", "ãƒªãƒ¯ãƒ¼ã‚¯", "return to work"],
      "åŠ´ç½": ["åŠ´åƒç½å®³", "æ¥­å‹™ç½å®³", "work injury"],
      "å®‰å…¨è¡›ç”Ÿ": ["åŠ´åƒå®‰å…¨è¡›ç”Ÿ", "è·å ´å®‰å…¨", "safety and health"],
      "åŒ–å­¦ç‰©è³ª": ["æœ‰å®³ç‰©è³ª", "å±é™ºç‰©è³ª", "chemical substance", "æœ‰æ©Ÿæº¶å‰¤"],
      "ç†±ä¸­ç—‡": ["æš‘ç†±éšœå®³", "heat stroke", "ç†±å°„ç—…"],
      "ãƒ†ãƒ¬ãƒ¯ãƒ¼ã‚¯": ["åœ¨å®…å‹¤å‹™", "ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯", "remote work"],
      "ä¸¡ç«‹æ”¯æ´": ["æ²»ç™‚ã¨ä»•äº‹ã®ä¸¡ç«‹", "ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹", "work-life balance"],
      "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ": ["ãƒ‘ãƒ¯ãƒãƒ©", "ã‚»ã‚¯ãƒãƒ©", "ã„ã˜ã‚", "å«ŒãŒã‚‰ã›", "harassment"],
      "ã†ã¤ç—…": ["ã†ã¤", "æŠ‘ã†ã¤", "depression", "æ°—åˆ†éšœå®³"],
      "ç¡çœ ": ["ä¸çœ ", "ç¡çœ éšœå®³", "sleep", "insomnia"],
      "ç–²åŠ´": ["ç–²ã‚Œ", "å€¦æ€ æ„Ÿ", "fatigue", "æ…¢æ€§ç–²åŠ´"],
      "å¥³æ€§": ["å¥³æ€§åŠ´åƒè€…", "åƒãå¥³æ€§", "female", "women"],
      "é«˜é½¢": ["é«˜å¹´é½¢", "ã‚·ãƒ‹ã‚¢", "elderly", "aging"],
      "å¥åº·çµŒå–¶": ["health management", "å¥åº·æŠ•è³‡", "ãƒ›ãƒ¯ã‚¤ãƒˆ500"],
      "ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ": ["ãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ", "work engagement", "åƒããŒã„"],
      "ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆ": ["ç‡ƒãˆå°½ã", "ç‡ƒãˆå°½ãç—‡å€™ç¾¤", "burnout"]
    };
    
    const searchInput = document.getElementById('searchInput');
    const synonymsInfo = document.getElementById('synonymsInfo');
    const searchBtn = document.getElementById('searchBtn');
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«data.jsonã‚’å–å¾—
    async function loadArticles() {
      try {
        const response = await fetch('data.json');
        const data = await response.json();
        
        // journalsã‹ã‚‰articlesã‚’å±•é–‹
        articles = [];
        for (const journal of data.journals) {
          for (const article of journal.articles) {
            articles.push({
              ...article,
              journal: journal.name
            });
          }
        }
        console.log(`${articles.length}ä»¶ã®è«–æ–‡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // åˆæœŸåŒ–
    loadArticles();
    
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') doSearch();
    });
    
    // é™çš„ã‚·ã‚½ãƒ¼ãƒ©ã‚¹æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    function getStaticSynonyms(keyword) {
      const kw = keyword.toLowerCase();
      let synonyms = [keyword];
      
      for (const [key, values] of Object.entries(thesaurus)) {
        if (key.toLowerCase() === kw || key.toLowerCase().includes(kw)) {
          synonyms = synonyms.concat(values);
          synonyms.push(key);
        }
        for (const v of values) {
          if (v.toLowerCase() === kw || v.toLowerCase().includes(kw)) {
            synonyms = synonyms.concat(values);
            synonyms.push(key);
            break;
          }
        }
      }
      
      return [...new Set(synonyms)];
    }
    
    // AIæ‹¡å¼µæ¤œç´¢ï¼ˆNetlify FunctionsçµŒç”±ï¼‰
    async function getAISynonyms(keyword) {
      try {
        const response = await fetch('/.netlify/functions/expand-query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: keyword })
        });
        
        if (!response.ok) {
          throw new Error('API request failed');
        }
        
        const data = await response.json();
        return data.synonyms || [keyword];
      } catch (error) {
        console.error('AI synonym expansion failed:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé™çš„ã‚·ã‚½ãƒ¼ãƒ©ã‚¹ã‚’ä½¿ç”¨
        return getStaticSynonyms(keyword);
      }
    }
    
    function highlightText(text, keywords) {
      let result = text;
      for (const kw of keywords) {
        const regex = new RegExp('(' + kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        result = result.replace(regex, '<mark>$1</mark>');
      }
      return result;
    }
    
    async function doSearch() {
      const keyword = searchInput.value.trim();
      if (!keyword) return;
      
      if (articles.length === 0) {
        document.getElementById('resultsArea').innerHTML = `
          <div class="no-results">
            <h3>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</h3>
            <p>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
          </div>
        `;
        await loadArticles();
      }
      
      const mode = document.querySelector('input[name="searchMode"]:checked').value;
      let searchTerms = [keyword];
      
      // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å‡¦ç†
      if (mode === 'ai') {
        // AIæ‹¡å¼µæ¤œç´¢
        searchBtn.disabled = true;
        searchBtn.textContent = 'AIåˆ†æä¸­...';
        document.getElementById('resultsArea').innerHTML = `
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>AIãŒé–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’åˆ†æã—ã¦ã„ã¾ã™...</p>
          </div>
        `;
        
        try {
          searchTerms = await getAISynonyms(keyword);
          showSynonymsInfo(searchTerms, true);
        } catch (error) {
          console.error(error);
          searchTerms = getStaticSynonyms(keyword);
          showSynonymsInfo(searchTerms, false);
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = 'æ¤œç´¢';
        }
      } else {
        // å®Œå…¨ä¸€è‡´
        synonymsInfo.classList.remove('show');
      }
      
      // æ¤œç´¢å®Ÿè¡Œ
      const results = articles.filter(article => {
        const text = (article.title + ' ' + article.authors.join(' ')).toLowerCase();
        return searchTerms.some(term => text.includes(term.toLowerCase()));
      });
      
      renderResults(results, searchTerms);
    }
    
    function showSynonymsInfo(terms, isAI) {
      const badge = isAI 
        ? '<span class="ai-badge">ğŸ¤– AIç”Ÿæˆ</span>' 
        : 'ğŸ” ';
      
      synonymsInfo.innerHTML = `
        ${badge}æ¤œç´¢èªã‚’æ‹¡å¼µã—ã¾ã—ãŸï¼ˆ${terms.length}èªï¼‰
        <div class="synonyms-list">
          ${terms.map(t => `<span class="synonym-tag">${t}</span>`).join('')}
        </div>
      `;
      synonymsInfo.classList.add('show');
    }
    
    function renderResults(results, keywords) {
      const area = document.getElementById('resultsArea');
      
      if (results.length === 0) {
        area.innerHTML = `
          <div class="no-results">
            <h3>è©²å½“ã™ã‚‹è«–æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
            <p>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„</p>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="results-header">
          <span class="results-count"><strong>${results.length}</strong> ä»¶ã®è«–æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</span>
        </div>
      `;
      
      for (const r of results) {
        const title = highlightText(r.title, keywords);
        const authors = r.authors.slice(0, 3).join(', ') + (r.authors.length > 3 ? ' ä»–' : '');
        const issue = r.year ? `${r.year}å¹´ ${r.volume}å·»${r.number}å·` : '';
        
        html += `
          <a href="${r.link}" target="_blank" class="result-item">
            <div class="result-title">${title}</div>
            <div class="result-meta">
              <span class="result-journal">${r.journal}</span>
              ${authors}${issue ? ' / ' + issue : ''}
            </div>
          </a>
        `;
      }
      
      area.innerHTML = html;
    }
  </script>
</body>
</html>
